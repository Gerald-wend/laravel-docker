#!/usr/bin/env bash

# verify ssh fingerprint
repository_provider="$( cut -d ':' -f 1-1 <<< "$GIT_REPOSITORY" )"; echo "$repository_provider"
ssh -T ${repository_provider}

if [ ! -d ".git" ]; then
    git clone -b ${GIT_BRANCH} ${GIT_REPOSITORY}
else
    git pull origin ${GIT_BRANCH}
fi

if [ ! -d "vendor" ]; then
    composer install
fi

if [[ "${ARTISAN_MIGRATE}" = 1 ]]; then
    php artisan migrate
    if [[ "${ARTISAN_SEED}" = 1 ]]; then
        php artisan db:seed
    fi
fi

if [ $# -gt 0 ];then
    exec gosu $WWWUSER "$@"
else
    if [[ "${ARTISAN_SERVE}" = 1 ]]; then
        php artisan serve --host 0.0.0.0 --port 8000q
    fi
fi
